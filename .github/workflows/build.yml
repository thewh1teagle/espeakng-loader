name: Publish espeak-ng-libs

on:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.archive }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest" # macOS arm64
            archive: "espeak-ng-libs-macos-arm64.tar.gz"

          - platform: "ubuntu-22.04" # Linux x86_64
            archive: "espeak-ng-libs-linux-x86_64.tar.gz"

          - platform: "windows-latest" # Windows x86_64
            archive: "espeak-ng-libs-windows-x86_64.zip"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: "true"

      - name: Build espeakng-loader
        run: ./build.sh

      - name: Create archive
        run: |
          mv espeak-ng/espeak-ng-libs.tar.gz ${{ matrix.archive }}
        shell: bash

      - name: Uplaod to releases
        run: |
          latestTag=$(gh release view --json tagName --jq '.tagName')
          gh release upload $latestTag ${{ matrix.archive }}.* --clobber
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
  checksum:
    runs-on: macos-latest
    needs: build
    steps:
      - name: Checksums Action
        uses: thewh1teagle/checksum@v1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}